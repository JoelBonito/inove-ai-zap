rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ================================================================
    // HELPERS
    // ================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }
    
    // ================================================================
    // INSTANCES (UAZAPI Credentials) - CLOUD FUNCTIONS ONLY
    // ================================================================
    
    match /instances/{ownerId} {
      // Bloqueia acesso direto - apenas Cloud Functions podem ler/escrever
      allow read, write: if false;
    }
    
    // ================================================================
    // CAMPAIGNS
    // ================================================================
    
    match /campaigns/{campaignId} {
      // Dono pode ler/escrever suas campanhas
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      
      // Logs de envio (subcollection)
      match /send_logs/{logId} {
        allow read: if isAuthenticated() && get(/databases/$(database)/documents/campaigns/$(campaignId)).data.ownerId == request.auth.uid;
        // Cloud Functions escrevem os logs
        allow write: if false;
      }
    }
    
    // ================================================================
    // CLIENTS (Multi-tenant)
    // ================================================================
    
    match /clients/{clientId} {
      // Cliente pode ler seus pr√≥prios dados
      allow read: if isOwner(clientId);
      allow write: if isOwner(clientId);
      
      // Contatos do cliente
      match /contacts/{contactId} {
        allow read, write: if isOwner(clientId);
      }
      
      // Categorias do cliente
      match /categories/{categoryId} {
        allow read, write: if isOwner(clientId);
      }
    }
    
    // ================================================================
    // USERS (Profile Data)
    // ================================================================
    
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // ================================================================
    // INSTANCE STATUS (Read by Owner, Write by Cloud Functions)
    // ================================================================
    
    match /instance_status/{ownerId} {
      allow read: if isOwner(ownerId);
      // Apenas Cloud Functions escrevem via webhooks
      allow write: if false;
    }
  }
}
